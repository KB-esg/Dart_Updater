name: DART Excel Download

on:
  schedule:
    - cron: '15 0 31 3 *'        # 3ì›” 31ì¼ ì˜¤ì „ 9ì‹œ 15ë¶„ (UTC+9)
    - cron: '15 0 17 5,8,11 *'   # 5ì›”, 8ì›”, 11ì›” 17ì¼ ì˜¤ì „ 9ì‹œ 15ë¶„ (UTC+9)
  workflow_dispatch:             # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: 'false'
        type: boolean
      custom_date_range:
        description: 'ì‚¬ìš©ì ì •ì˜ ë‚ ì§œ ë²”ìœ„ ì‚¬ìš©'
        required: false
        default: 'false'
        type: boolean
      start_date:
        description: 'ì‹œì‘ì¼ (YYYYMMDD í˜•ì‹, ì˜ˆ: 20240101)'
        required: false
        default: ''
        type: string
      end_date:
        description: 'ì¢…ë£Œì¼ (YYYYMMDD í˜•ì‹, ì˜ˆ: 20241231)'
        required: false
        default: ''
        type: string
      number_unit:
        description: 'ìˆ«ì í‘œì‹œ ë‹¨ìœ„'
        required: false
        default: 'million'
        type: choice
        options:
          - million      # ë°±ë§Œì›
          - hundred_million  # ì–µì›
          - billion      # ì‹­ì–µì›
      save_new_accounts:
        description: 'ì‹ ê·œ ê³„ì •ëª…ì„ ë³„ë„ íŒŒì¼ë¡œ ì €ì¥'
        required: false
        default: 'false'
        type: boolean

jobs:
  download-dart-excel:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      # API í‚¤ ë° ì¸ì¦ ì •ë³´
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      
      # íšŒì‚¬ ì •ë³´ (ì—¬ëŸ¬ íšŒì‚¬ ì²˜ë¦¬ ì‹œ matrix ì‚¬ìš© ê¶Œì¥)
      COMPANY_CORP_CODE: '032640'
      COMPANY_NAME: 'LGìœ í”ŒëŸ¬ìŠ¤'
      COMPANY_SPREADSHEET_VAR: 'LGUPLUS_SPREADSHEET_ID'
      LGUPLUS_SPREADSHEET_ID: ${{ secrets.LGUPLUS_SPREADSHEET_ID }}
      
      # ì‹¤í–‰ ì˜µì…˜
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
      CUSTOM_DATE_RANGE: ${{ github.event.inputs.custom_date_range || 'false' }}
      MANUAL_START_DATE: ${{ github.event.inputs.start_date }}
      MANUAL_END_DATE: ${{ github.event.inputs.end_date }}
      ENABLE_ARCHIVE_UPDATE: 'true'
      NUMBER_UNIT: ${{ github.event.inputs.number_unit || 'million' }}  # ë‹¨ìœ„ ì„¤ì •
      SAVE_NEW_ACCOUNTS: ${{ github.event.inputs.save_new_accounts || 'false' }}  # ì‹ ê·œ ê³„ì •ëª… ì €ì¥
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install gspread google-auth google-auth-oauthlib google-auth-httplib2
            pip install opendartreader pandas openpyxl playwright requests tqdm
          fi
          
          # Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
          echo "ğŸŒ Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜..."
          playwright install chromium
          playwright install-deps chromium
          
      - name: Verify environment
        run: |
          echo "ğŸ” í™˜ê²½ í™•ì¸"
          echo "ğŸ¢ ëŒ€ìƒ ê¸°ì—…: $COMPANY_NAME ($COMPANY_CORP_CODE)"
          echo "ğŸ“… ë‚ ì§œ ë²”ìœ„: $([ "$CUSTOM_DATE_RANGE" = "true" ] && echo "$MANUAL_START_DATE ~ $MANUAL_END_DATE" || echo "ìµœê·¼ 3ê°œì›”")"
          echo "ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ: $DEBUG_MODE"
          echo "ğŸ’° ìˆ«ì ë‹¨ìœ„: $NUMBER_UNIT"
          echo "ğŸ“ ì‹ ê·œ ê³„ì •ëª… ì €ì¥: $SAVE_NEW_ACCOUNTS"
          
      - name: Run DART Excel downloader
        id: download
        run: |
          echo "ğŸš€ DART Excel ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
          
          # ë‹¨ìœ„ í‘œì‹œ
          case "$NUMBER_UNIT" in
            "million") echo "ğŸ’° ë‹¨ìœ„: ë°±ë§Œì›" ;;
            "hundred_million") echo "ğŸ’° ë‹¨ìœ„: ì–µì›" ;;
            "billion") echo "ğŸ’° ë‹¨ìœ„: ì‹­ì–µì›" ;;
          esac
          
          if [ "$DEBUG_MODE" = "true" ]; then
            python -u Dart_update.py
          else
            python Dart_update.py
          fi
          
          # ì‹¤í–‰ ê²°ê³¼ í™•ì¸
          if [ $? -eq 0 ]; then
            echo "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        
      - name: Upload logs and new accounts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-logs-${{ github.run_number }}
          path: |
            *.log
            new_accounts_*.txt
          retention-days: 30
          
      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“Š DART Excel ë‹¤ìš´ë¡œë“œ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¢ íšŒì‚¬ | $COMPANY_NAME ($COMPANY_CORP_CODE) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… ì‹¤í–‰ ì‹œê°„ | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’° ìˆ«ì ë‹¨ìœ„ | $NUMBER_UNIT |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ ì‹ ê·œ ê³„ì •ëª… ì €ì¥ | $SAVE_NEW_ACCOUNTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… ì„±ê³µ ì—¬ë¶€ | ${{ steps.download.outputs.success || 'false' }} |" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: download-dart-excel
    if: always()
    
    steps:
      - name: Send notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          NUMBER_UNIT: ${{ github.event.inputs.number_unit || 'million' }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHANNEL_ID" ]; then
            STATUS_EMOJI=$([ "${{ needs.download-dart-excel.result }}" = "success" ] && echo "âœ…" || echo "âŒ")
            STATUS_TEXT=$([ "${{ needs.download-dart-excel.result }}" = "success" ] && echo "ì„±ê³µ" || echo "ì‹¤íŒ¨")
            
            # ë‹¨ìœ„ í…ìŠ¤íŠ¸ ë³€í™˜
            case "$NUMBER_UNIT" in
              "million") UNIT_TEXT="ë°±ë§Œì›" ;;
              "hundred_million") UNIT_TEXT="ì–µì›" ;;
              "billion") UNIT_TEXT="ì‹­ì–µì›" ;;
              *) UNIT_TEXT="ë°±ë§Œì›" ;;
            esac
            
            MESSAGE="ğŸ¤– DART Excel ë‹¤ìš´ë¡œë“œ $STATUS_TEXT
            
            ğŸ“Š LGìœ í”ŒëŸ¬ìŠ¤ (032640)
            ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')
            ğŸ’° ë‹¨ìœ„: $UNIT_TEXT
            ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHANNEL_ID}" \
              -d "text=${MESSAGE}"
          fi
