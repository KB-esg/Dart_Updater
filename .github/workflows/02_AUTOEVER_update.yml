name: 02_í˜„ëŒ€ì˜¤í† ì—ë²„_DART Update (XBRL v4)

on:
  schedule:
    - cron: '15 0 31 3 *'        # 3ì›” 31ì¼ ì˜¤ì „ 9ì‹œ 15ë¶„ (UTC+9)
    - cron: '15 0 17 5,8,11 *'   # 5ì›”, 8ì›”, 11ì›” 17ì¼ ì˜¤ì „ 9ì‹œ 15ë¶„ (UTC+9)
  workflow_dispatch:             # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: 'false'
        type: boolean
      custom_date_range:
        description: 'ì‚¬ìš©ì ì •ì˜ ë‚ ì§œ ë²”ìœ„ ì‚¬ìš©'
        required: false
        default: 'false'
        type: boolean
      start_date:
        description: 'ì‹œì‘ì¼ (YYYYMMDD í˜•ì‹, ì˜ˆ: 20240101)'
        required: false
        default: ''
        type: string
      end_date:
        description: 'ì¢…ë£Œì¼ (YYYYMMDD í˜•ì‹, ì˜ˆ: 20241231)'
        required: false
        default: ''
        type: string

jobs:
  update-dart-reports:
    runs-on: ubuntu-latest
    timeout-minutes: 45          # XBRL ì²˜ë¦¬ ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì¦ê°€
    
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      AUTOEVER_SPREADSHEET_ID: ${{ secrets.AUTOEVER_SPREADSHEET_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
      CUSTOM_DATE_RANGE: ${{ github.event.inputs.custom_date_range || 'false' }}
      MANUAL_START_DATE: ${{ github.event.inputs.start_date }}
      MANUAL_END_DATE: ${{ github.event.inputs.end_date }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # ìµœì‹  Python ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          cache: 'pip'
          
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify environment variables
        run: |
          echo "ğŸ” í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì¤‘..."
          required_vars=("DART_API_KEY" "GOOGLE_CREDENTIALS" "AUTOEVER_SPREADSHEET_ID" "TELEGRAM_BOT_TOKEN" "TELEGRAM_CHANNEL_ID")
          
          for var in "${required_vars[@]}"; do
            if [ -n "${!var}" ]; then
              value="${!var}"
              length=${#value}
              
              if [ $length -gt 4 ]; then
                if [ $length -gt 20 ]; then
                  # ê¸´ ê°’: ì²˜ìŒ 6ìë¦¬ + ... + ë§ˆì§€ë§‰ 4ìë¦¬ ì¤‘ ì• 2ìë¦¬ + **
                  masked="${value:0:6}...${value: -4:-2}**"
                else
                  # ì§§ì€ ê°’: ë§ˆì§€ë§‰ 2ìë¦¬ë§Œ **ë¡œ ê°€ë¦¼
                  masked="${value:0:-2}**"
                fi
                echo "âœ… $var: $masked (ê¸¸ì´: $length)"
              else
                echo "âš ï¸ $var: ê°’ì´ ë„ˆë¬´ ì§§ìŒ (ê¸¸ì´: $length)"
              fi
            else
              echo "âŒ Error: $var is not set"
              exit 1
            fi
          done
          
          echo "ğŸ”§ Debug mode: $DEBUG_MODE"
          echo "ğŸ“… Custom date range: $CUSTOM_DATE_RANGE"
          if [ "$CUSTOM_DATE_RANGE" = "true" ]; then
            echo "ğŸ“… Start date: $MANUAL_START_DATE"
            echo "ğŸ“… End date: $MANUAL_END_DATE"
          fi
          echo "ğŸƒ Runner OS: ${{ runner.os }}"
          echo "ğŸ Python version: $(python --version)"
          
      - name: Validate date inputs
        if: github.event.inputs.custom_date_range == 'true'
        run: |
          echo "ğŸ“… ë‚ ì§œ ì…ë ¥ê°’ ê²€ì¦ ì¤‘..."
          
          start_date="${{ github.event.inputs.start_date }}"
          end_date="${{ github.event.inputs.end_date }}"
          
          if [ -z "$start_date" ] || [ -z "$end_date" ]; then
            echo "âŒ ì‚¬ìš©ì ì •ì˜ ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí–ˆì§€ë§Œ ì‹œì‘ì¼ ë˜ëŠ” ì¢…ë£Œì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          # ë‚ ì§œ í˜•ì‹ ê²€ì¦
          if ! [[ $start_date =~ ^[0-9]{8}$ ]] || ! [[ $end_date =~ ^[0-9]{8}$ ]]; then
            echo "âŒ ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. YYYYMMDD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
            echo "ì˜ˆ: 20240101, 20241231"
            exit 1
          fi
          
          # ë‚ ì§œ ìˆœì„œ ê²€ì¦
          if [ "$start_date" -gt "$end_date" ]; then
            echo "âŒ ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤."
            echo "ì‹œì‘ì¼: $start_date, ì¢…ë£Œì¼: $end_date"
            exit 1
          fi
          
          # ë‚ ì§œ ë²”ìœ„ ê³„ì‚° (ê°„ë‹¨í•œ ê³„ì‚°)
          start_year=${start_date:0:4}
          start_month=${start_date:4:2}
          start_day=${start_date:6:2}
          end_year=${end_date:0:4}
          end_month=${end_date:4:2}
          end_day=${end_date:6:2}
          
          # 2ë…„ ì´ˆê³¼ ê²€ì¦ (ëŒ€ëµì )
          year_diff=$((end_year - start_year))
          if [ $year_diff -gt 2 ]; then
            echo "âŒ ë‚ ì§œ ë²”ìœ„ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (2ë…„ ì´ˆê³¼). ë” ì§§ì€ ê¸°ê°„ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          echo "âœ… ë‚ ì§œ ê²€ì¦ ì™„ë£Œ"
          echo "ğŸ“… ì²˜ë¦¬ ë²”ìœ„: $start_date ~ $end_date"
          echo "ğŸ“… ê¸°ê°„: ì•½ $year_diffë…„"
          
      - name: Create log directory
        run: |
          mkdir -p logs
          echo "ğŸ“ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
          
      - name: Run XBRL DART update script
        id: update-dart
        run: |
          echo "ğŸš€ XBRL ê¸°ë°˜ DART ì—…ë°ì´íŠ¸ ì‹œì‘..."
          
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰"
            python -u 307950_dart_update_xbrl.py 2>&1 | tee logs/dart_update.log
          else
            python 307950_dart_update_xbrl.py 2>&1 | tee logs/dart_update.log
          fi
          
          # ì‹¤í–‰ ê²°ê³¼ í™•ì¸
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… DART ì—…ë°ì´íŠ¸ ì„±ê³µ"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ DART ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        
      - name: Check execution results
        run: |
          echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½:"
          echo "- ì„±ê³µ ì—¬ë¶€: ${{ steps.update-dart.outputs.success }}"
          echo "- ì¢…ë£Œ ì½”ë“œ: ${{ steps.update-dart.outcome }}"
          
          if [ -f "logs/dart_update.log" ]; then
            echo "- ë¡œê·¸ íŒŒì¼ í¬ê¸°: $(du -h logs/dart_update.log | cut -f1)"
            echo "- ë§ˆì§€ë§‰ 10ì¤„:"
            tail -10 logs/dart_update.log
          fi
          
      - name: Upload execution logs
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: dart-update-logs-${{ github.run_number }}
          path: |
            logs/
            *.log
            *.txt
            *.json
          retention-days: 30
          compression-level: 6
          
      - name: Upload failure logs (detailed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: dart-failure-debug-${{ github.run_number }}
          path: |
            logs/
            *.log
            *.txt
            *.json
            *.xml
            /tmp/*.log
          retention-days: 7
          compression-level: 9
          if-no-files-found: warn
          
      - name: Clean up sensitive data
        if: always()
        run: |
          echo "ğŸ§¹ ë¯¼ê°í•œ ë°ì´í„° ì •ë¦¬ ì¤‘..."
          
          # ì„ì‹œ íŒŒì¼ë“¤ ì‚­ì œ
          find . -name "*.tmp" -delete 2>/dev/null || true
          find . -name "*credentials*" -delete 2>/dev/null || true
          find /tmp -name "*dart*" -delete 2>/dev/null || true
          
          # í™˜ê²½ë³€ìˆ˜ ì •ë¦¬
          unset DART_API_KEY
          unset GOOGLE_CREDENTIALS
          unset TELEGRAM_BOT_TOKEN
          
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
          
      - name: Summary report
        if: always()
        run: |
          echo "## ğŸ“‹ DART ì—…ë°ì´íŠ¸ ì‹¤í–‰ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¢ íšŒì‚¬ | í˜„ëŒ€ì˜¤í† ì—ë²„ (307950) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… ì‹¤í–‰ ì‹œê°„ | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ ì‹¤í–‰ ë²ˆí˜¸ | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… ì„±ê³µ ì—¬ë¶€ | ${{ steps.update-dart.outputs.success || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ | $DEBUG_MODE |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CUSTOM_DATE_RANGE" = "true" ]; then
            echo "| ğŸ“… ë‚ ì§œ ë²”ìœ„ | ì‚¬ìš©ì ì •ì˜ |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“… ì‹œì‘ì¼ | $MANUAL_START_DATE |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“… ì¢…ë£Œì¼ | $MANUAL_END_DATE |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“… ë‚ ì§œ ë²”ìœ„ | ê¸°ë³¸ (ìµœê·¼ 3ê°œì›”) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.update-dart.outcome }}" = "success" ]; then
            echo "### âœ… ì—…ë°ì´íŠ¸ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            echo "XBRL/HTML ì´ì›í™” ì‹œìŠ¤í…œìœ¼ë¡œ DART ë°ì´í„° ì—…ë°ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            if [ "$CUSTOM_DATE_RANGE" = "true" ]; then
              echo "ì‚¬ìš©ìê°€ ì§€ì •í•œ ë‚ ì§œ ë²”ìœ„($MANUAL_START_DATE ~ $MANUAL_END_DATE)ì˜ ëª¨ë“  ë³´ê³ ì„œë¥¼ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "DART ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ë¡œê·¸: \`dart-update-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.update-dart.outcome }}" != "success" ]; then
            echo "- ì‹¤íŒ¨ ìƒì„¸ ë¡œê·¸: \`dart-failure-debug-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          fi

  notify-completion:
    runs-on: ubuntu-latest
    needs: update-dart-reports
    if: always()
    
    steps:
      - name: Send completion notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHANNEL_ID" ]; then
            
            if [ "${{ needs.update-dart-reports.result }}" = "success" ]; then
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="ì„±ê³µ"
            else
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="ì‹¤íŒ¨"
            fi
            
            # ë‚ ì§œ ë²”ìœ„ ì •ë³´
            if [ "$CUSTOM_DATE_RANGE" = "true" ]; then
              DATE_INFO="ğŸ“… ì²˜ë¦¬ ë²”ìœ„: $MANUAL_START_DATE ~ $MANUAL_END_DATE (ì‚¬ìš©ì ì§€ì •)"
            else
              DATE_INFO="ğŸ“… ì²˜ë¦¬ ë²”ìœ„: ìµœê·¼ 3ê°œì›” (ìë™)"
            fi
            
            MESSAGE=$(cat << EOF
          ğŸ¤– GitHub Actions ì•Œë¦¼
          
          ğŸ“‹ ì‘ì—…: DART ì—…ë°ì´íŠ¸ (XBRL/HTML ì´ì›í™”)
          ğŸ¢ íšŒì‚¬: í˜„ëŒ€ì˜¤í† ì—ë²„ (307950)
          ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ${DATE_INFO}
          ${STATUS_EMOJI} ê²°ê³¼: ${STATUS_TEXT}
          ğŸ”— ì›Œí¬í”Œë¡œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          #DART #í˜„ëŒ€ì˜¤í† ì—ë²„ #ìë™í™” #ì´ì›í™”ì‹œìŠ¤í…œ
          EOF
          )
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHANNEL_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML"
              
            echo "ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
          else
            echo "âš ï¸ í…”ë ˆê·¸ë¨ ì„¤ì •ì´ ì—†ì–´ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤"
          fi
