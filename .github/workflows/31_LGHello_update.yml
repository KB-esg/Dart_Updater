name: LG Hellovision DART Update

on:
  schedule:
    - cron: '2 0 31 3 *'        # 3월 31일 오전 9시(UTC 0시)
    - cron: '2 0 17 5,8,11 *'   # 5월, 8월, 11월 17일 오전 9시(UTC 0시)
  workflow_dispatch:             # 수동 실행 가능

jobs:
  update-dart-reports:
    runs-on: ubuntu-latest
    timeout-minutes: 30         # 작업 시간 제한
    
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      LGHELLO_SPREADSHEET_ID: ${{ secrets.LGHELLO_SPREADSHEET_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4    # v4로 업데이트
        
      - name: Set up Python
        uses: actions/setup-python@v5  # v5로 업데이트
        with:
          python-version: '3.9'
          cache: 'pip'               # 의존성 캐싱 활성화
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || {
            pip install gspread oauth2client google-auth google-auth-oauthlib google-auth-httplib2 
            pip install opendartreader pandas beautifulsoup4 html_table_parser tqdm requests
          }
          
      - name: Verify environment variables
        run: |
          echo "Checking environment variables..."
          for var in "DART_API_KEY" "GOOGLE_CREDENTIALS" "LGHELLO_SPREADSHEET_ID" "TELEGRAM_BOT_TOKEN" "TELEGRAM_CHANNEL_ID"; do
            if [ -z "${!var}" ]; then
              echo "Error: $var is not set"
              exit 1
            else
              echo "$var exists: true"
            fi
          done
          
      - name: Run DART update script
        id: update-dart
        run: |
          python 037560_dart_update.py
        continue-on-error: true    # 스크립트 실패해도 계속 진행
          
      - name: Send Telegram notification
        if: always()              # 항상 실행
        run: |
          if [ "${{ steps.update-dart.outcome }}" == "success" ]; then
            python -c "
            import requests
            import os
            from datetime import datetime
            
            bot_token = os.environ['TELEGRAM_BOT_TOKEN']
            chat_id = os.environ['TELEGRAM_CHANNEL_ID']
            
            message = f'''✅ DART 업데이트 완료
            
            • 종목: LG헬로비전 (037560)
            • 실행 시간: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
            • GitHub Action 상태: 성공'''
            
            requests.post(
                f'https://api.telegram.org/bot{bot_token}/sendMessage',
                data={'chat_id': chat_id, 'text': message, 'parse_mode': 'HTML'}
            )"
          else
            python -c "
            import requests
            import os
            from datetime import datetime
            
            bot_token = os.environ['TELEGRAM_BOT_TOKEN']
            chat_id = os.environ['TELEGRAM_CHANNEL_ID']
            
            message = f'''❌ DART 업데이트 실패
            
            • 종목: LG헬로비전 (037560)
            • 실행 시간: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
            • GitHub Action 상태: 실패
            
            GitHub Actions 로그를 확인해주세요.'''
            
            requests.post(
                f'https://api.telegram.org/bot{bot_token}/sendMessage',
                data={'chat_id': chat_id, 'text': message, 'parse_mode': 'HTML'}
            )"
          fi
